{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow">
            <div class="card-header bg-success bg-gradient">
                <h2 class="card-title mb-0 text-white">
                    <i class="fas fa-check-circle me-2"></i>Processing Results
                </h2>
            </div>
            <div class="card-body">
                <h3 class="border-bottom pb-2">
                    <i class="fas fa-file-pdf text-danger me-2"></i>{{ filename }}
                </h3>
                
                <div class="row mt-4">
                    <!-- AI Result Section -->
                    <div class="col-md-7 order-md-1 order-2">
                        <div class="card mb-4 h-100">
                            <div class="card-header bg-primary">
                                <h4 class="mb-0">
                                    <i class="fas fa-robot me-2"></i>AI Analysis
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="ai-response">
                                    {% if ai_result %}
                                        <div class="ai-content">
                                            {{ ai_result|safe|replace('\n', '<br>')|replace('  ', '&nbsp;&nbsp;') }}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            No AI response received. There might have been an issue with the AI processing.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-outline-primary" id="copyAiBtn">
                                        <i class="fas fa-copy me-1"></i>Copy
                                    </button>
                                    <div id="copyAiSuccess" class="text-success" style="display: none;">
                                        <i class="fas fa-check me-1"></i>Copied!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extracted Text Section -->
                    <div class="col-md-5 order-md-2 order-1">
                        <div class="card mb-4 h-100">
                            <div class="card-header bg-secondary">
                                <h4 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>Extracted Text
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="extracted-text overflow-auto" style="max-height: 350px;">
                                    {% if extracted_text %}
                                        <pre class="text-wrap">{{ extracted_text }}</pre>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            No text was extracted from the PDF.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% if extracted_text and "..." in extracted_text %}
                                        Showing partial text (truncated for display)
                                    {% else %}
                                        Showing complete extracted text
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Process Another PDF
                    </a>
                    <button class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download me-2"></i>Download Results
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy AI result to clipboard
        const copyAiBtn = document.getElementById('copyAiBtn');
        const copyAiSuccess = document.getElementById('copyAiSuccess');
        
        copyAiBtn.addEventListener('click', function() {
            const aiContent = document.querySelector('.ai-content').innerText;
            
            navigator.clipboard.writeText(aiContent).then(function() {
                // Show success message
                copyAiSuccess.style.display = 'block';
                setTimeout(function() {
                    copyAiSuccess.style.display = 'none';
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy to clipboard');
            });
        });
        
        // Download results as text file
        const downloadBtn = document.getElementById('downloadBtn');
        
        downloadBtn.addEventListener('click', function() {
            const filename = '{{ filename }}'.replace('.pdf', '') + '_results.txt';
            const aiContent = document.querySelector('.ai-content').innerText;
            const extractedText = document.querySelector('.extracted-text pre').innerText;
            
            const content = `PROCESSED PDF: {{ filename }}\n\n` +
                            `AI ANALYSIS:\n${'='.repeat(50)}\n${aiContent}\n\n` +
                            `EXTRACTED TEXT:\n${'='.repeat(50)}\n${extractedText}\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(function() {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        });
    });
</script>
{% endblock %}
